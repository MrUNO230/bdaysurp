<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Birthday, My Love!</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: #f0f0f0;
            color: #333;
            overflow: hidden;
            height: 100%;
        }

        .section {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            visibility: hidden;
            /* transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out; */ /* Keep Commented for GSAP */
            background-size: cover;
            background-position: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .particle-background-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
        }

        .section h1,
        .section p,
        .section button {
            position: relative;
            z-index: 1;
        }

        .section.active {
            z-index: 1;
        }

        #loading-screen { background-color: #ffc0cb; }
        #welcome-screen { background-color: #add8e6; }
        #balloon-screen { background-color: #90ee90; }
        #gallery-screen { background-color: #fffacd; }
        #cake-screen { background-color: #ffdab9; }
        #message-screen { background-color: #dda0dd; }
        #song-screen { background-color: #f0e68c; }
        #final-screen { background-color: #e6e6fa; }

        h1 { font-size: 3em; color: #ff69b4; margin-bottom: 20px; }
        p { font-size: 1.2em; line-height: 1.6; }
        button { padding: 15px 30px; font-size: 1.2em; background-color: #ff69b4; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px; transition: background-color 0.3s ease; }
        button:hover { background-color: #ff1493; }
        .balloon-container { position: relative; width: 100%; height: 80%; overflow: hidden; }
        .balloon { position: absolute; width: 80px; height: 100px; background-color: red; border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; color: white; cursor: pointer; box-shadow: inset -5px -5px 10px rgba(0,0,0,0.2); }
        .balloon::after { content: ''; position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%); width: 2px; height: 40px; background: #555; }
        .swiper-container { width: 80%; max-width: 600px; height: auto; max-height: 70vh; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.2); }
        .swiper-slide img { display: block; width: 100%; height: auto; object-fit: contain; max-height: 65vh; }
        .swiper-slide p { font-size: 1em; color: #555; margin-top: 10px; }
        #cake-container { position: relative; width: 200px; height: 250px; }
        .cake-body { width: 100%; height: 150px; background-color: #f2d7b6; border-radius: 10px 10px 0 0; position: absolute; bottom: 0; border: 3px solid #d2b48c; }
        /* Improved cake and icing styles */
        .cake-body {
            width: 100%;
            height: 120px; /* Adjusted cake body height */
            background-color: #fffacd; /* More yellow cake color */
            border-radius: 8px 8px 0 0; /* Increased border radius */
            position: absolute;
            bottom: 0;
            border: 2px solid #d2c2b3; /* Softer border */
            box-shadow: 0 5px 10px rgba(0,0,0,0.1); /* Added shadow */
        }
        .icing { width: 105%; height: 30px; background-color: #ffe4e1; position: absolute; top: -15px; left: -2.5%; border-radius: 50% / 15px; border: 1px solid #ffb6c1; box-shadow: 0 3px 8px rgba(0,0,0,0.08); } /* Adjusted icing */
        /* Modified candle and flame styles */
        .candle { width: 8px; height: 30px; background-color: #fff; position: absolute; top: -15px; /* Adjusted candle top position */ border: 1px solid #d3d3d3; border-radius: 2px; }
        .flame { width: 6px; height: 10px; background-color: #ffa500; border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; position: absolute; top: -8px; left: 1px; transform-origin: bottom center; box-shadow: 0 0 5px #ffa500; }
        #candle1 { left: 30%; top: 105px; }
        #candle2 { left: 50%; transform: translateX(-50%); top: 105px; }
        #candle3 { left: 70%; top: 105px; }
        #typed-message { font-size: 1.5em; min-height: 100px; width: 80%; max-width: 700px; background: rgba(255,255,255,0.7); padding: 20px; border-radius: 10px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="loading-screen" class="section active">
        <h1>Preparing Your Birthday Surprise!</h1>
        <p>Just a moment, my love!</p>
       <div id="particles-js-loading" class="particle-background-container"></div>
    </div>
    <div id="welcome-screen" class="section">
        <div id="particles-js-welcome" class="particle-background-container"></div>
        <h1 id="welcome-text">[Girlfriend's Name]!</h1>
        <p>This is a little something I made just for you.</p>
        <button onclick="nextSection()">Start Your Celebration!</button>
    </div>

    <!-- MODIFIED: Button removed from balloon screen -->
    <div id="balloon-screen" class="section">
        <h1>Pop Some Joy!</h1>
        <p>Click the balloons to reveal some birthday cheer!</p>
        <div class="balloon-container" id="balloon-field"></div>
        <!-- <button onclick="nextSection()">Next Surprise!</button> -->
    </div>

    <div id="gallery-screen" class="section"><h1>Our Cherished Moments</h1><div class="swiper-container"><div class="swiper-wrapper"></div><div class="swiper-pagination"></div><div class="swiper-button-next"></div><div class="swiper-button-prev"></div></div><button onclick="nextSection()">Ready for Cake?</button></div>
    <div id="cake-screen" class="section"><h1>Make a Wish!</h1><div id="cake-container" onclick="blowOutCandles()"><div class="cake-body"><div class="icing"></div></div><div class="candle" id="candle1"><div class="flame" id="flame1"></div></div><div class="candle" id="candle2"><div class="flame" id="flame2"></div></div><div class="candle" id="candle3"><div class="flame" id="flame3"></div></div></div><p id="cake-message">Click the cake to blow out the candles!</p><button onclick="nextSection()" id="cake-next-button" style="display:none;">What's Next?</button></div>
    <div id="message-screen" class="section"><h1>A Little Note For You</h1><div id="typed-message-container"><p id="typed-message"></p></div><button onclick="nextSection()">One More Thing...</button></div>
    <div id="song-screen" class="section"><h1>Our Special Song</h1><p>Let this play for you...</p><audio id="birthday-song" controls loop><source src="birthday.mp3" type="audio/mpeg">Your browser does not support the audio element.</audio><p id="song-title">Song: [Her Favorite Song / Your Song Title]</p><button onclick="nextSection()">The Grand Finale!</button></div>
    <div id="final-screen" class="section"><h1>I Love You, [Girlfriend's Name]!</h1><p>I hope you have the most wonderful birthday ever. You deserve all the happiness in the world.</p><p>With all my love,<br>[Your Name]</p><button onclick="replaySurprise()">Replay the Surprise?</button></div>

    <script>
        // --- CONFIGURATION ---
        const girlfriendName = "My Sunshine";
        const yourName = "Your Boo";
        const photos = [
            { src: "b1.png", caption: "Our first amazing adventure!" },
            { src: "b2.png", caption: "That hilarious moment we shared." },
            { src: "b3.png", caption: "You looked so beautiful here." },
        ];
        const personalMessage = `Dearest ${girlfriendName},\n\nEvery day with you feels like a celebration, but today is extra special.\nI wanted to create something unique to show you just how much you mean to me.\n\nHere are a few reasons why I adore you:\n- Your incredible smile that lights up my world.\n- Your kindness and compassion towards everyone.\n- The way you make me laugh even on tough days.\n- Your strength and determination.\n- Simply put, you make my life better in every single way.\n\nHappy Birthday, my love. I hope this little surprise brings a smile to your face.\nI can't wait to celebrate many more birthdays with you.\n\nAll my love,\n${yourName}`;
        const songURL = "birthday.mp3";
        const songTitle = "Our Special Song";
        const balloonPopSoundURL = "button-09.mp3";
        const cheerSoundURL = "applause-01.mp3";
        // --- END OF CONFIGURATION ---

        let currentSection = 0;
        const sections = document.querySelectorAll('.section');
        let backgroundMusic;
        let popSound;
        let cheerSound;
        let candlesBlownOut = false;
        let activeBalloonsCount = 0; // MODIFIED: For tracking balloons

        function initSounds() {
            console.log("Initializing sounds...");
            if (songURL) {
                backgroundMusic = new Howl({ src: [songURL], loop: true, volume: 0.3, html5: true });
                console.log("Background music Howl object created.");
            } else { console.warn("Background music URL not set."); }
            if (balloonPopSoundURL) popSound = new Howl({ src: [balloonPopSoundURL], volume: 0.7 });
            if (cheerSoundURL) cheerSound = new Howl({ src: [cheerSoundURL], volume: 0.8 });
            console.log("Sound effects Howl objects created.");
        }

        const tsParticlesConfig = { /* ... (same as before, OMITTED FOR BREVITY) ... */ };
        const confettiConfig = { /* ... (same as before, OMITTED FOR BREVITY) ... */ };
        // To keep code shorter, I'll put the full configs at the end if needed, assume they are here.

        function showSection(index) {
            console.log(`showSection called with index: ${index}`);
            sections.forEach((sectionElement, i) => {
                if (i === index) {
                    console.log(`Activating section ${i} (${sectionElement.id || 'no id'})`);
                    sectionElement.classList.add('active');
                    gsap.fromTo(sectionElement,
                        { autoAlpha: 0, y: 50 },
                        {
                            autoAlpha: 1, y: 0, duration: 0.8, ease: "power2.out",
                            onComplete: () => console.log(`GSAP animation TO VISIBLE complete for section ${i} (${sectionElement.id || 'no id'})`)
                        }
                    );
                } else {
                    if (sectionElement.classList.contains('active')) {
                        console.log(`Deactivating section ${i} (${sectionElement.id || 'no id'})`);
                    }
                    sectionElement.classList.remove('active');
                    gsap.to(sectionElement, {
                        autoAlpha: 0,
                        duration: 0.5,
                        onComplete: () => console.log(`GSAP animation TO HIDDEN complete for section ${i} (${sectionElement.id || 'no id'})`)
                    });
                }
            });
            console.log("Section class toggling and GSAP main animation init done for index: " + index);

            if (index === 0) {
                console.log("Setting up Loading Screen (section 0) particles");
                tsParticles.load("particles-js-loading", { ...tsParticlesConfig, particles: {...tsParticlesConfig.particles, color: {value: "#FFF"}, line_linked: { color: "#FFF" } } });
            }
            if (index === 1) {
                console.log("Setting up Welcome Screen (section 1)");
                gsap.from("#welcome-text", { opacity: 0, scale: 0.5, duration: 1, delay: 0.5, ease: "elastic.out(1, 0.5)" });

                console.log("DEBUG: Skipping tsParticles.load for welcome screen.");
                // tsParticles.load("particles-js-welcome", tsParticlesConfig);

                if (backgroundMusic && !backgroundMusic.playing()) {
                    console.log("Attempting to play background music.");
                    backgroundMusic.play();
                }
                console.log("Welcome Screen (section 1) JS setup logic complete.");
            }
            if (index === 2) { // MODIFIED: Balloon screen logic
                console.log("Setting up Balloon Screen (section 2)");
                createBalloons(10); // Create 10 balloons (or your desired number)
            }
            if (index === 4) { animateFlames(); }
            if (index === 5) { typeMessage(personalMessage, 'typed-message'); }
            if (index === 6 && backgroundMusic && !backgroundMusic.playing()) { backgroundMusic.play(); }
        }

        function nextSection() {
            console.log(`nextSection called. currentSection: ${currentSection}`);
            if (currentSection < sections.length - 1) {
                if (currentSection === 1 && backgroundMusic && !backgroundMusic.playing()) {
                    console.log("Music not playing on welcome screen, playing via nextSection.");
                    backgroundMusic.play();
                }
                currentSection++;
                showSection(currentSection);
            } else { console.log("Already on last section."); }
        }

        function replaySurprise() {
            console.log("replaySurprise called.");
            if (backgroundMusic && backgroundMusic.playing()) { backgroundMusic.stop(); }

            document.querySelectorAll('.flame').forEach(flame => { flame.style.display = 'block'; gsap.set(flame, { opacity: 1 }); });
            document.getElementById('cake-message').textContent = "Click the cake to blow out the candles!";
            document.getElementById('cake-next-button').style.display = 'none';
            candlesBlownOut = false;
            console.log("Cake state reset. candlesBlownOut:", candlesBlownOut);

            currentSection = 1;
            showSection(currentSection);
        }

        // MODIFIED: createBalloons function
        function createBalloons(count) {
            const container = document.getElementById('balloon-field');
            container.innerHTML = '';
            activeBalloonsCount = count; // Initialize/reset the count
            console.log(`Creating ${activeBalloonsCount} balloons.`);

            const colors = ['#FF6347', '#4682B4', '#32CD32', '#FFD700', '#6A5ACD', '#FF69B4'];
            if (count === 0) { // Edge case: if no balloons, proceed
                 console.log("No balloons to create, moving to next section immediately.");
                 setTimeout(() => nextSection(), 100); // Small delay
                 return;
            }
            for (let i = 0; i < count; i++) {
                const balloon = document.createElement('div');
                balloon.classList.add('balloon');
                balloon.dataset.balloonId = i;
                balloon.style.backgroundColor = colors[i % colors.length];
                balloon.style.left = `${Math.random() * 85}%`;
                balloon.style.bottom = `-${Math.random() * 100 + 50}px`;
                balloon.addEventListener('click', () => popBalloon(balloon));
                container.appendChild(balloon);
                gsap.to(balloon, { y: `-${window.innerHeight * 0.8 + Math.random() * 100}`, x: `${(Math.random() - 0.5) * 100}`, rotation: `${(Math.random() - 0.5) * 30}`, duration: Math.random() * 5 + 5, ease: "sine.inOut", repeat: -1, yoyo: true, delay: Math.random() * 2 });
            }
        }

        // MODIFIED: popBalloon function
        function popBalloon(balloonElement) {
            if (!balloonElement || balloonElement.classList.contains('popped')) {
                console.log("Attempted to pop an invalid or already popped balloon.");
                return;
            }
            balloonElement.classList.add('popped');

            if (popSound) {
                console.log("Playing pop sound.");
                popSound.play();
            }

            const rect = balloonElement.getBoundingClientRect();
            const confettiEmitter = { ...confettiConfig.emitters, position: { x: (rect.left + rect.width / 2) * 100 / window.innerWidth, y: (rect.top + rect.height / 2) * 100 / window.innerHeight } };
            tsParticles.load({ particles: confettiConfig.particles, emitters: confettiEmitter });

            gsap.killTweensOf(balloonElement);
            gsap.to(balloonElement, {
                scale: 0,
                opacity: 0,
                duration: 0.3,
                onComplete: () => {
                    balloonElement.remove();
                    activeBalloonsCount--;
                    console.log(`Balloon popped. Remaining balloons: ${activeBalloonsCount}`);

                    if (activeBalloonsCount <= 0) {
                        console.log("All balloons popped! Moving to next section.");
                        setTimeout(() => {
                            nextSection();
                        }, 700); // Increased delay slightly for effect
                    }
                }
            });
        }

        function animateFlames() { document.querySelectorAll('.flame').forEach(f=>{gsap.to(f,{scaleY:1.1,scaleX:1.05,skewX:"random(-5,5)",duration:"random(.2,.5)",repeat:-1,yoyo:true,ease:"sine.inOut"});});}
        function blowOutCandles() { if(candlesBlownOut)return;candlesBlownOut=true;if(cheerSound)cheerSound.play();document.querySelectorAll('.flame').forEach(f=>{gsap.to(f,{opacity:0,duration:.5,onComplete:()=>f.style.display='none'});});document.getElementById('cake-message').textContent="Woohoo! Happy Birthday!";const cr=document.getElementById('cake-container').getBoundingClientRect();const ce={...confettiConfig.emitters,position:{x:(cr.left+cr.width/2)*100/window.innerWidth,y:(cr.top+cr.height/4)*100/window.innerHeight},rate:{quantity:200,delay:.05}};tsParticles.load({particles:confettiConfig.particles,emitters:ce});gsap.to("#cake-next-button",{display:'inline-block',opacity:1,duration:.5,delay:1});}
        function typeMessage(message, elementId, speed = 50) {
            const element = document.getElementById(elementId);
            if (!element) {
                console.error(`Element with ID ${elementId} not found.`);
                return;
            }
            element.innerHTML = '';
            let i = 0;
            const timer = setInterval(() => {
                if (i < message.length) {
                    element.innerHTML += message.charAt(i);
                    i++;
                } else {
                    clearInterval(timer);
                }
            }, speed);
        }
        function initSwiper() { const w=document.querySelector('#gallery-screen .swiper-wrapper');w.innerHTML='';photos.forEach(p=>{const s=document.createElement('div');s.classList.add('swiper-slide');const i=document.createElement('img');i.src=p.src;i.alt=p.caption;const capt=document.createElement('p');capt.textContent=p.caption;s.appendChild(i);s.appendChild(capt);w.appendChild(s)});new Swiper('.swiper-container',{loop:true,grabCursor:true,effect:'cube',cubeEffect:{shadow:true,slideShadows:true,shadowOffset:20,shadowScale:.94},pagination:{el:'.swiper-pagination',clickable:true},navigation:{nextEl:'.swiper-button-next',prevEl:'.swiper-button-prev'},autoplay:{delay:4000,disableOnInteraction:false}});}

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded event fired.");
            document.getElementById('welcome-text').textContent = `Happy Birthday, ${girlfriendName}!`;
            document.querySelector('#final-screen h1').textContent = `I Love You, ${girlfriendName}!`;
            document.querySelector('#final-screen p:nth-of-type(2)').innerHTML = `With all my love,<br>${yourName}`;

            const birthdaySongElement = document.getElementById('birthday-song');
            if (birthdaySongElement) birthdaySongElement.src = songURL;
            const songTitleElement = document.getElementById('song-title');
            if(songTitleElement) songTitleElement.textContent = `Song: ${songTitle}`;

            initSounds();
            initSwiper();
            console.log("Initial sounds and swiper initialized.");

            console.log("Setting initial GSAP states for sections...");
            sections.forEach((s, i) => {
                if (s.classList.contains('active')) {
                    gsap.set(s, { autoAlpha: 1, y: 0 });
                    console.log(`Section ${i} (${s.id}) is active, set to autoAlpha:1, y:0`);
                    if (currentSection === i) { showSection(i); }
                } else {
                    gsap.set(s, { autoAlpha: 0, y: 50 });
                    console.log(`Section ${i} (${s.id}) is not active, set to autoAlpha:0, y:50`);
                }
            });
            console.log("Initial GSAP states set.");

            setTimeout(() => {
                console.log("Timeout finished. Attempting to destroy loading particles.");
                const allParticlesInstances = tsParticles.dom();
                let loadingParticlesInstance = null;
                for (const instance of allParticlesInstances) { /* ... (same robust find logic) ... */ }
                if (loadingParticlesInstance) { /* ... destroy ... */ }
                else { console.log("No loading particles instance for 'particles-js-loading' found to destroy."); }

                currentSection = 1;
                console.log("Calling showSection to display Welcome Screen (index 1).");
                showSection(currentSection);
                console.log("Returned from initial showSection(1) call.");
            }, 3000);
        });
    </script>
</body>
</html>